using LibrarySystem.Models;
using LibrarySystem.Services;
using System;
using System.Collections.Generic;
using System.Reflection.PortableExecutable;

namespace LibrarySystem
{
    class Program
    {
        private static LibraryService libraryService = new LibraryService();
        private static FileService fileService = new FileService();

        static void Main(string[] args)
        {
            Console.WriteLine("Witamy w systemie bibliotecznym!");
            //zgrywa dane
            fileService.LoadData(libraryService);

            bool exit = false;
            while (!exit)
            {   //pokazuje menu
                DisplayMenu();
                string choice = Console.ReadLine();

                switch (choice)
                {
                    case "1":
                        //dodaj książkę
                        AddBook();
                        break;
                    case "2":
                        //dodaj czytelnika
                        AddReader();
                        break;
                    case "3":
                        //wypożycz książkę
                        BorrowBook();
                        break;
                    case "4":
                        //oddaj książkę
                        ReturnBook();
                        break;
                    case "5":
                        //pokaż wszystkie ksziążki
                        ShowAllBooks();
                        break;
                    case "6":
                        //pokaż wszystkie dostępne ksziążki
                        ShowAvailableBooks();
                        break;
                    case "7":
                        //pokaż wszystkich użytkowników
                        ShowAllReaders();
                        break;
                    case "8":
                        //pokaź rekords wypożyczeń
                        ShowAllBorrowRecords();
                        break;
                    case "9":
                        //wyszukaj ksziążke/i
                        SearchBooks();
                        break;
                    case "10":
                        //pokaż po terminie
                        ShowOverdueBooks();
                        break;
                    case "11":
                        //zapisz dane
                        fileService.SaveData(libraryService);
                        break;
                    case "0":
                        //wyjdż z programu
                        exit = true;
                        fileService.SaveData(libraryService);
                        Console.WriteLine("Dziękujemy za korzystanie z systemu!");
                        break;
                    default:
                        //nieprawidłowy wybór
                        Console.WriteLine("Nieprawidłowy wybór. Spróbuj ponownie.");
                        break;
                }

                Console.WriteLine("\nNaciśnij dowolny klawisz, aby kontynuować...");
                Console.ReadKey();
                Console.Clear();
            }
        }
        //menu
        static void DisplayMenu()
        {
            Console.WriteLine(" SYSTEM BIBLIOTECZNY ");
            Console.WriteLine(" 1. Dodaj książkę                 ");
            Console.WriteLine(" 2. Dodaj czytelnika              ");
            Console.WriteLine(" 3. Wypożycz książkę              ");
            Console.WriteLine(" 4. Zwróć książkę                 ");
            Console.WriteLine(" 5. Pokaż wszystkie książki       ");
            Console.WriteLine(" 6. Pokaż dostępne książki        ");
            Console.WriteLine(" 7. Pokaż czytelników             ");
            Console.WriteLine(" 8. Pokaż wypożyczenia            ");
            Console.WriteLine(" 9. Wyszukaj książki              ");
            Console.WriteLine(" 10. Pokaż przetrzymywane książki ");
            Console.WriteLine(" 11. Zapisz dane                  ");
            Console.WriteLine(" 0. Zakończ program               ");
            Console.WriteLine(" Wybierz opcję:  ");
            Console.Write("");
        }

        static void AddBook()
        {
            Console.Write("Tytuł: ");
            string title = Console.ReadLine();
            Console.Write("Autor: ");
            string author = Console.ReadLine();
            Console.Write("Rok wydania: ");
            int year = int.Parse(Console.ReadLine());
            Console.Write("Numer katalogowy: ");
            string catalogNumber = Console.ReadLine();
            //tworzy ksziążkę
            var book = new Book(title, author, year, catalogNumber);
            libraryService.AddBook(book);
            Console.WriteLine("Książka została dodana.");
        }

        static void AddReader()
        {
            Console.Write("Imię: ");
            string firstName = Console.ReadLine();
            Console.Write("Nazwisko: ");
            string lastName = Console.ReadLine();
            Console.Write("Numer karty bibliotecznej: ");
            string cardNumber = Console.ReadLine();
            //tworzy użytkownika
            var reader = new Reader(firstName, lastName, cardNumber);
            libraryService.AddReader(reader);
            Console.WriteLine("Czytelnik został zarejestrowany.");
        }

        static void BorrowBook()
        {
            var books = libraryService.GetAllBooks();
            Console.Write("Numer katalogowy książki: ");
            string bookNumber = Console.ReadLine();
            Console.Write("Numer karty czytelnika: ");
            string readerCard = Console.ReadLine();

            if (libraryService.BorrowBook(bookNumber, readerCard))
            {
                Console.WriteLine("Książka została wypożyczona.");
            }
            if (!libraryService.BorrowBook(bookNumber, readerCard))
            {
                Console.WriteLine("Książki nie ma w bazie");
            }
            else
            {
                Console.WriteLine("Nie udało się wypożyczyć książki. Sprawdź czy książka i czytelnik istnieją oraz czy książka jest dostępna.");
            }
        }

        static void ReturnBook()
        {
            Console.Write("Numer katalogowy książki do zwrotu: ");
            string bookNumber = Console.ReadLine();

            if (libraryService.ReturnBook(bookNumber))
            {
                Console.WriteLine("Książka została zwrócona.");
            }
            else
            {
                Console.WriteLine("Nie udało się zwrócić książki. Sprawdź numer katalogowy.");
            }
        }

        static void ShowAllBooks()
        {
            var books = libraryService.GetAllBooks();
            Console.WriteLine("WSZYSTKIE KSIĄŻKI");
            if (books.Count == 0)
            {
                Console.WriteLine("Brak książek w systemie.");
            }
            else
            {
                foreach (var book in books)
                {
                    Console.WriteLine(book);
                }
            }
        }

        static void ShowAvailableBooks()
        {
            var books = libraryService.GetAvailableBooks();
            Console.WriteLine("DOSTĘPNE KSIĄŻKI");
            if (books.Count == 0)
            {
                Console.WriteLine("Brak dostępnych książek.");
            }
            else
            {
                foreach (var book in books)
                {
                    Console.WriteLine(book);
                }
            }
        }

        static void ShowAllReaders()
        {
            var readers = libraryService.GetAllReaders();
            Console.WriteLine("CZYTELNICY");
            if (readers.Count == 0)
            {
                Console.WriteLine("Brak zarejestrowanych czytelników.");
            }
            else
            {
                foreach (var reader in readers)
                {
                    Console.WriteLine(reader);
                }
            }
        }

        static void ShowAllBorrowRecords()
        {
            var records = libraryService.GetAllBorrowRecords();
            Console.WriteLine("HISTORIA WYPOŻYCZEŃ");
            if (records.Count == 0)
            {
                Console.WriteLine("Brak wypożyczeń w systemie.");
            }
            else
            {
                foreach (var record in records)
                {
                    Console.WriteLine(record);
                }
            }
        }

        static void SearchBooks()
        {
            Console.Write("Wpisz tytuł lub autora do wyszukania: ");
            string searchTerm = Console.ReadLine();

            var results = libraryService.SearchBooks(searchTerm);
            Console.WriteLine($"WYNIKI WYSZUKIWANIA DLA: '{searchTerm}'");

            if (results.Count == 0)
            {
                Console.WriteLine("Nie znaleziono książek.");
            }
            else
            {
                foreach (var book in results)
                {
                    Console.WriteLine(book);
                }
            }
        }

        static void ShowOverdueBooks()
        {
            var overdueBooks = libraryService.GetOverdueBooks();
            Console.WriteLine("KSIĄŻKI PRZETRZYMYWANE PO TERMINIE");

            if (overdueBooks.Count == 0)
            {
                Console.WriteLine("Brak przetrzymywanych książek.");
            }
            else
            {
                foreach (var record in overdueBooks)
                {
                    Console.WriteLine(record);
                }
            }
        }
    }
}